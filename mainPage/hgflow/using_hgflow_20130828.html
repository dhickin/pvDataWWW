<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
      "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
  <title>Branched Development with hg flow</title>
  <link rel="stylesheet" type="text/css"
  href="http://epics-pvdata.sourceforge.net/base.css" />
  <link rel="stylesheet" type="text/css"
  href="http://epics-pvdata.sourceforge.net/epicsv4.css" />
  <style type="text/css">
  /*<![CDATA[*/
     .about { margin-left: 3em; margin-right: 3em; font-size: .83em}
     table { margin-left: auto; margin-right: auto }
     .diagram { text-align: center; margin: 2.5em 0 }
     span.opt { color: grey }
     span.nterm { font-style:italic }
     span.term { font-family:courier }
     span.user { font-family:courier }
     span.user:before { content:"<" }
     span.user:after { content:">" }
     .nonnorm { font-style:italic }
     p.ed { color: #AA0000 }
     span.ed { color: #AA0000 }
     p.ed.priv { display: inline; }
     span.ed.priv { display: inline; }
  /*]]>*/</style>
  <!-- Script that generates the Table of Contents -->
  <script type="text/javascript"
  src="http://epics-pvdata.sourceforge.net/script/tocgen.js">
 </script>
</head>

<body>

<div class="head">
<h1>Using hg flow for Branched Development</h1>
<!-- Maturity: Working Draft or Request for Comments, or Recommendation, and date. -->

<h2 class="nocount">EPICS V4 Working Group, Working Draft, 28-Aug-2013</h2>
<dl>
  <dt>Latest version:</dt>
    <dd><a href="using_hgflow.html">using_hgflow.html</a></dd>
  <dt>This version:</dt>
    <dd><a href="using_hgflow_20130828.html">using_hgflow_20130828.html</a></dd>
  <dt>Previous version:</dt>
    <dd>None</dd>
  <dt>Editors:</dt>
    <dd>Ralph Lange, Helmholtz-Zentrum Berlin für Materialien und Energie /
      BESSY II</dd>
  <dt>License:</dt>
    <dd>Creative Commons BY-SA</dd>
</dl>
</div>

<h2 class="nocount">Abstract</h2>

<p>The Mercurial plug-in <a href="https://bitbucket.org/yujiewu/hgflow"
target="_blank">hg flow</a> implements a generalized <a
href="http://nvie.com/posts/a-successful-git-branching-model/"
target="_blank">Driessen branching model</a>. This document describes the basic
feature of the model and how hg flow and its high-level commands can be applied
to EPICS V4 development repositories.</p>

<p>This document is accompanied by a <a href="hgflow-sample">shell scrip</a>t
that executes all procedures mentioned. The script itself can be used as a
reference, the sample repository is a nice disposable sandbox. </p>

<h2 class="nocount">Status of this Document</h2>

<p>This document describes the suggested hg flow procedures for EPICS V4
development as of 2013-08-28. It is not complete, and is intended to be a
background for informed discussion and decision.</p>

<h2 class="nocount">TODO</h2>

<p>describe working with hotfix branches.</p>

<p>Describe working with support branches.</p>

<p>Describe --dirty option.</p>

<p>Describe procedures for multiple master trunks, i.e., parallel development
of several versions.</p>

<div id="toc">
<h2 class="nocount">Table of Contents</h2>
</div>

<div id="contents" class="contents">
<h2>Introduction</h2>

<p>Since modern distributed revision control systems have gained popularity
within software developers, many branching and workflow models have been
developed, which differ in features and grade of adoption.</p>

<p>A particular model that has gained wide-spread popularity is the workflow
developed and described 2010 by Vincent Driessen, originally for the Git
version control system, referred to as the <a
href="http://nvie.com/posts/a-successful-git-branching-model/"
target="_blank">Driessen branching model</a>.</p>

<p>For the Mercurial community, Yujie Wu develops and supports a Mercurial
plugin called <a href="https://bitbucket.org/yujiewu/hgflow" target="_blank">hg
flow</a> that implements a generalized version of the Driessen model. It offers
convenient high-level commands for operations on branches, avoiding the complex
and mechanical low-level operations needed to achieve the required
operations.</p>

<p>This document uses the original illustrations by Vincent Driessen.</p>

<h3>Why Branched Development?</h3>

<p>For larger projects with many developers, a model based on one development
line in a central repository is not working well. Processes like large feature
developments (with multiple developers involved) and the preparation of a new
release (going through phases of pre-releases and release candidates) can take
weeks and would block the development of other features or important bugfixes.
Support of older versions is hard. Tracking bugfixes across releases is
tedious.</p>

<h3>Features of the Generalized Driessen Model</h3>

<p>Vincent Driessen published a branched development model for Git in a <a
href="http://nvie.com/posts/a-successful-git-branching-model/"
target="_blank">blog article</a> in January 2010. His original model was later
extended with the addition of <em>support branches</em> allowing long-term
support of older releases. The <em>stream</em> generalization allows to group
branches in a directory-like fashion.</p>

<div>
<p><a href="http://nvie.com/files/Git-branching-model.pdf"><img
alt="Driessen Branching Model" src="model.png" style="float: right" width="611"
height="815" /></a> </p>

<p>There are two main trunks with an infinite lifetime (i.e., created at
initialization and never closed):</p>
<ul>
  <li>The <em><strong>develop</strong> </em>trunk<em></em> carries the main
    line of development. All changes, features, and fixes are eventually merged
    into <code>develop</code>. Small developments needing only one or two
    commits can happen directly on <code>develop</code> trunk, larger features
    or features for a future release (i.e., not the next release) should be
    developed in feature branches.</li>
  <li>The <em><strong>master</strong> </em>trunk<em></em> carries the main line
    of releases. Every commit (usually a merge commit) on <code>master</code>
    is a release, and should be tagged accordingly.</li>
</ul>

<p>There are four additional streams (groups of branches), which carry a
varying number of branches (i.e., branches are created and closed as part of
the workflow):</p>
<ul>
  <li>A <em><strong>support</strong></em> stream branch is created off a
    specific release (i.e., a specific commit on <code>master</code>), and
    carries bugfix releases for that parent release. It is similar to the
    master trunk: every commit is a release, and it is never closed.</li>
  <li>The <em><strong>feature</strong> </em>stream branches carry development
    of features that are either complex and/or intended for a later release.
    They are created off <code>develop</code> (either off develop trunk or off
    a develop branch), and are merged back into their parent.</li>
  <li>A <em><strong>release</strong> </em>stream branch is created off
    <code>develop</code> (trunk or branch) when the releasing process starts.
    It collects all changes necessary for that particular release (bugfixes,
    tags), but no feature developments. When the release process is done, the
    release branch gets merged into <code>master</code> (creating the release),
    and into its parent (feeding back the changes into the development
  stream).</li>
  <li>A <em><strong>hotfix</strong> </em>stream branch is similar to a release
    branch, but created off <code>master</code> (or a support branch). It
    collects all changes necessary for fixing a bug and for a possibly
    shortened release process. When the fix is tested and can be released, the
    hotfix branch gets merged into its parent (creating the release), and often
    into <code>develop</code> trunk (feeding back the changes into the
    development stream).</li>
</ul>
</div>

<p>Sub-streams of <code>develop</code> and <code>feature</code> can be created
in a directory-like hierarchy, to collect branches that belong together. E.g.,
the developments during a certain code sprint or codeathon could go into a
develop sub-stream, or different parts of a complex feature could be developed
in a feature sub-stream.</p>

<p>The following table lists the different types of branches in the Driessen
model, with their most important properties.</p>

<table style="width: 100%">
  <caption>Branch Types in the Driessen Model</caption>
  <col />
  <col />
  <col />
  <col />
  <col />
  <thead>
    <tr>
      <td>Name</td>
      <td>Purpose</td>
      <td>Properties</td>
      <td>Created from</td>
      <td>Merged into</td>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><em>develop trunk</em></td>
      <td>main line "next release" development</td>
      <td>minor features (~2 commits or less) are done directly on
        <code>develop</code>, major features or developments for a future
        version are done on a feature branch</td>
      <td>-</td>
      <td>-</td>
    </tr>
    <tr>
      <td><em>master trunk</em></td>
      <td>main line of releases</td>
      <td>every commit is a release</td>
      <td>-</td>
      <td>-</td>
    </tr>
    <tr>
      <td><em>support branches</em></td>
      <td>support releases (for older releases)</td>
      <td>long term support (e.g., bugfixes) for older releases, every commit
        is a release</td>
      <td>master trunk (at the appropriate release)</td>
      <td>-</td>
    </tr>
    <tr>
      <td><em>develop branches</em></td>
      <td>grouping developments</td>
      <td>developments for a specific release, or during a specific
        sprint/codeathon</td>
      <td>develop trunk (or develop branch)</td>
      <td>(its parent branch and) develop trunk, closing creates a release
        branch</td>
    </tr>
    <tr>
      <td><em>feature branches</em></td>
      <td>feature development</td>
      <td>each major feature uses a dedicated feature branch for
      development</td>
      <td>develop trunk (or develop branch)</td>
      <td>(its parent branch and) develop trunk</td>
    </tr>
    <tr>
      <td><em>release branches</em></td>
      <td>release preparation</td>
      <td>contains all changes that are necessary for a specific release,
        between first pre-release and the final release</td>
      <td>development trunk (or develop branch)</td>
      <td>master trunk and (its parent branch and) develop trunk</td>
    </tr>
    <tr>
      <td><em>hotfix branches</em></td>
      <td>fixing bugs</td>
      <td>fixes for urgent bugs in released versions</td>
      <td>master trunk, or support branch</td>
      <td>master trunk and develop trunk, or support branch</td>
    </tr>
  </tbody>
</table>

<p>Within the context of hg flow, the term <em>stream</em> is used for either a
set of related branches, either at the top level or at the branch level, or for
an individual branch. Some hg flow operations can be applied as well to an
individual branch as to a stream, i.e. to all individual branches that belong
to that stream.</p>

<p>Features of this branched development model that might or might not be
present in other models:</p>
<ul>
  <li>The streams separate commits and tags by functionality, making the
    history (commit log) of each stream much clearer: 
    <p>The develop and feature streams only contain development commits (and
    merges). The release stream only contains commits and tags from the
    releasing process. The master stream only contains public releases. The
    hotfix stream only contains bugfix commits.</p>
  </li>
  <li>The releasing process is done on a branch and does not hold up
    development in any way.</li>
  <li>As each commit on <code>master</code> is a public release, it is easy to
    connect CI publishing jobs to it.</li>
</ul>

<h3>Usage in the Context of EPICS V4 Development</h3>

<p>Only a small subset of the described features and streams is mandatory and
should be used at the beginning. After explaining the <a
href="#installation">installation and setup</a> of the hg flow plugin for
Mercurial, the <a href="#basic_procedures">Basic Procedures</a> section covers
the initial workflow operations. These include the mandatory
<code>develop</code> and <code>master</code> trunks, developing on feature
branches, and releasing on release branches.</p>

<p>The <a href="#advanced_features">Advanced Features</a> section describes
operations on that can be introduced as needed: bug fixing on hotfix branches
and long-term support of older releases on support branches. <em
style="color:#ff0000">This section is not complete.</em></p>

<h2>Sample Script</h2>

<p>You can execute the <a href="hgflow-sample">sample script</a>, which will
create a repository in a subdirectory called sample, and run all described
operations using a small set of text files. </p>

<h2>Installation and Configuration of hg flow<a name="installation"
id="installation"></a></h2>

<p>Install hg flow (&gt;= 0.9.6) according to the <a
href="https://bitbucket.org/yujiewu/hgflow/wiki/Home.wiki#!installation"
target="_blank">installation instructions</a>:</p>
<ul>
  <li>Download the latest release from the <a
    href="https://bitbucket.org/yujiewu/hgflow/downloads"
    target="_blank">download page</a>.</li>
  <li>Unpack hgflow.py into an arbitrary directory, e.g.,
  <code>~/.hgext</code>.</li>
  <li>Edit the hg configuration file <code>~/.hgrc</code> (or
    <code>%USERPROFILE%/Mercurial.ini</code> on Windows), adding a line to the
    <code>[extensions]</code> section: 
    <pre>[extensions]
flow = /PATH/TO/hgflow.py</pre>
  </li>
  <li>Make sure to enable the <a
    href="http://mercurial.selenic.com/wiki/MqExtension" target="_blank">mq</a>
    and <a href="http://mercurial.selenic.com/wiki/RebaseExtension"
    target="_blank">rebase</a> extensions (in the same place): 
    <pre>[extensions]
mq =
rebase =</pre>
  </li>
  <li>Enable autoshelve (not mandatory). This will automatically shelve and
    unshelve uncommitted changes when switching between branches. Add the
    following to the hg configuration file: 
    <pre>[flow]
autoshelve = true</pre>
    This feature needs the <a
    href="http://mercurial.selenic.com/wiki/MqExtension" target="_blank">mq
    extension</a>.</li>
  <li>Set the version prefix (used for release tag names) to the empty string.
    Add the following to the hg configuration file: 
    <pre>[flow]
version_prefix = ''</pre>
  </li>
</ul>

<h2>Basic Procedures<a name="basic_procedures"></a></h2>

<h3>Be Safe</h3>

<p>Branched development is no picnic. Be aware of structures and procedures.</p>

<p>Back up your repository (local copy using <code>cp -a</code>) before complex
operations.</p>

<p>Every hg flow command takes <code>--dry-run</code> as an option to print out
what the command would do, without changing the repository. Check if it will do
what you intend to.</p>

<p>Use the built-in help function: <code>hg flow help</code> will get you
started.</p>

<h3>Initialize hg flow for an Existing Repository</h3>

<p>The EPICS V4 repositories will have an existing development history in the
<code>default</code> branch when being initialized for use with hg flow. This
needs a small change to the default setup, as we will use the
'<code>default</code>' branch for the develop trunk, and create a new branch
'<code>master</code>' for the master trunk.</p>

<p>In the top level of your repository, run the <code>hg flow init</code>
command:</p>
<pre>&gt; <strong>hg flow init</strong>
flow: Global configuration:
flow:   autoshelve: on

Branch name for master stream: [default] <strong>master</strong>
Branch name for develop stream: [develop] <strong>default</strong>
Branch name for feature stream: [feature/] 
Branch name for release stream: [release/] 
Branch name for hotfix stream: [hotfix/] 
Branch name for support stream: [support/] 
marked working directory as branch master
(branches are permanent and global, did you want a bookmark?)
0 files updated, 0 files merged, 0 files removed, 0 files unresolved</pre>

<p>See the <a href="#hg_init">low-level commands</a>.</p>

<h3>Navigate Between Branches</h3>

<p>You can switch to any branch or trunk using the <code>hg flow
&lt;stream&gt;</code> command:</p>
<pre>&gt; <strong>hg flow develop</strong>
flow: Update workspace to &lt;develop&gt; trunk.
0 files updated, 0 files merged, 0 files removed, 0 files unresolved
flow: &lt;develop&gt; trunk: default
flow: Open &lt;develop&gt; branches:
flow:   default*</pre>
<pre>&gt; <strong>hg flow feature addFile3</strong>
flow: Update workspace to &lt;feature&gt; 'addFile3'.
1 files updated, 0 files merged, 0 files removed, 0 files unresolved</pre>

<p>See the <a href="#hg_develop">low-level commands</a>.</p>

<h3>Simple Development on Develop Trunk</h3>

<p>Switch to the <code>develop</code> trunk:</p>
<pre>&gt; <strong>hg flow develop</strong>
flow: Update workspace to &lt;develop&gt; trunk.
0 files updated, 0 files merged, 0 files removed, 0 files unresolved
flow: &lt;develop&gt; trunk: default
flow: Open &lt;develop&gt; branches:
flow:   default*</pre>

<p>Edit and commit as usual.</p>

<h3>Development on a Feature Branch</h3>

<p><img alt="Feature Branch" src="fb.png" style="float: right" width="133"
height="352" /></p>

<p>Create a feature branch off <code>develop</code> trunk:</p>
<pre>&gt; <strong>hg flow feature start addFile3</strong>
0 files updated, 0 files merged, 0 files removed, 0 files unresolved
marked working directory as branch feature/addFile3</pre>

<p>See the <a href="#hg_feature_start">low-level commands</a>.</p>

<p>Edit and commit as usual.</p>

<p>When feature development is complete, finish the branch (first you might
have to navigate to the branch you want to finish):</p>
<pre>&gt; <strong>hg flow feature addFile3</strong>
flow: You are already in &lt;feature&gt; 'addFile3'.
&gt; <strong>hg flow feature finish</strong>
1 files updated, 0 files merged, 0 files removed, 0 files unresolved
1 files updated, 0 files merged, 0 files removed, 0 files unresolved
(branch merge, don't forget to commit)</pre>

<p>The feature branch is closed, and merged back into the <code>develop</code>
trunk. See the <a href="#hg_feature_finish">low-level commands</a>.</p>

<h3>Release Process</h3>

<p>Create the release branch off <code>develop</code> trunk:</p>
<pre>&gt; <strong>hg flow release start 1.0.0</strong>
0 files updated, 0 files merged, 0 files removed, 0 files unresolved
marked working directory as branch release/1.0.0</pre>

<p>See the <a href="#hg_release_start">low-level commands</a>.</p>

<p>Change, commit and tag preparing for the release. This includes all changes
necessary for pre-release and release-candidate stages, up to preparing the
final release. Then finish the release branch:</p>
<pre>&gt; <strong>hg flow release finish</strong>
1 files updated, 0 files merged, 2 files removed, 0 files unresolved
3 files updated, 0 files merged, 0 files removed, 0 files unresolved
(branch merge, don't forget to commit)
2 files updated, 0 files merged, 3 files removed, 0 files unresolved
5 files updated, 0 files merged, 0 files removed, 0 files unresolved
(branch merge, don't forget to commit)</pre>

<p>The release branch is closed, and merged back into <code>develop</code>
trunk as well as the <code>master</code> trunk (creating the release), where it
is tagged. See the <a href="#hg_release_finish">low-level commands</a>.</p>

<h2>Advanced Features</h2>

<h3>Autoshelve</h3>

<p>Developing using a branched model often leads to situations where you want
to switch to a different branch while having uncommitted changes in your
working directory that you want top keep with the original branch.</p>

<p>The <code>autoshelve</code> feature (see <a
href="#installation">Installation</a> section) uses Mercurial's mq extension to
automatically shelve your uncommitted changes when you leave a branch, and
unshelve them when you return. It tracks your uncommitted changes for each open
branch.</p>

<p><span style="color:#ff0000"><span style="font-size: 14pt">This section is
not complete.</span></span></p>

<h2>Low-Level hg Commands</h2>

<p>This chapter shows the 'mechanical' low-level commands that hg flow executes
to implement the high-level commands mentioned in this document. Someone not
using the hg flow plugin can seamlessly achieve the same results using these
'simple' versions.</p>

<h3>hg flow init<a name="hg_init"></a></h3>
<pre>hg add .hgflow 
hg commit --message "flow initialization: Added configuration file." .hgflow 
hg branch master 
hg commit --message "flow initialization: Created &lt;master&gt; trunk: master."</pre>

<h3>hg flow develop<a name="hg_develop"></a></h3>
<pre>hg update default</pre>

<h3>hg flow feature<a name="hg_feature"></a></h3>
<pre>hg update feature/addFile3</pre>

<h3>hg flow feature start<a name="hg_feature_start"></a></h3>
<pre>hg update default 
hg branch feature/addFile3 
hg commit --message "flow: Created branch 'feature/addFile3'."</pre>

<h3>hg flow feature finish<a name="hg_feature_finish"></a></h3>
<pre>hg commit --message "flow: Closed &lt;feature&gt; 'addFile3'." --close-branch
hg update default 
hg merge feature/addFile3 
hg commit --message "flow: Merged &lt;feature&gt; 'addFile3' to &lt;develop&gt; ('default')."</pre>

<h3>hg flow release start<a name="hg_release_start"></a></h3>
<pre>hg update default 
hg branch release/1.0.0 
hg commit --message "flow: Created branch 'release/1.0.0'."</pre>

<h3>hg flow release finish<a name="hg_release_finish"></a></h3>
<pre>hg commit --message "flow: Closed &lt;release&gt; '1.0.0'." --close-branch
hg update default 
hg merge release/1.0.0 
hg commit --message "flow: Merged &lt;release&gt; '1.0.0' to &lt;develop&gt; ('default')."
hg update master 
hg merge release/1.0.0 
hg commit --message "flow: Merged &lt;release&gt; '1.0.0' to &lt;master&gt; ('master')."
hg tag 1.0.0</pre>

<p></p>
</div>
</body>
</html>
